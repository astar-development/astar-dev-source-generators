using System.Collections.Generic;
using System.Text;

namespace AStar.Dev.Source.Generators.OptionsBindingGeneration;

internal static class OptionsBindingCodeGenerator
{
    public static string Generate(IReadOnlyList<OptionsTypeInfo> types)
    {
        var sb = new StringBuilder();
        _ = sb.AppendLine("// <auto-generated/>");
        _ = sb.AppendLine("using Microsoft.Extensions.DependencyInjection;");
        _ = sb.AppendLine("using Microsoft.Extensions.Configuration;");
        _ = sb.AppendLine();
        _ = sb.AppendLine("namespace AStar.Dev.Source.Generators.OptionsBindingGeneration");
        _ = sb.AppendLine("{");
        _ = sb.AppendLine("    public static class AutoOptionsRegistrationExtensions");
        _ = sb.AppendLine("    {");
        _ = sb.AppendLine("        public static IServiceCollection AddAutoRegisteredOptions(this IServiceCollection services, IConfiguration configuration)");
        _ = sb.AppendLine("        {");
        foreach(OptionsTypeInfo info in types) _ = sb.AppendLine($"            services.AddOptions<{info.FullTypeName}>()\n                .Bind(configuration.GetSection(\"{EscapeString(info.SectionName)}\"))\n                .ValidateDataAnnotations()\n                .ValidateOnStart();");

        _ = sb.AppendLine("            return services;");
        _ = sb.AppendLine("        }");
        _ = sb.AppendLine("    }");
        _ = sb.AppendLine("}");
        return sb.ToString();
    }

    private static string EscapeString(string s) => s?.Replace("\\", @"\\").Replace("\"", "\\\"") ?? string.Empty;
}
